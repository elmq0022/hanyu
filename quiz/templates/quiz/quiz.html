{% extends "_base.html" %}

{% block content %}
    <!-- general form elements -->
    <div class="box box-primary">
    <div class="box-header with-border">
        <h3 class="box-title">Quiz</h3>
    </div>
    <!-- /.box-header -->
    <!-- form start -->
    <form role="form" onsubmit="return submitAnswer();">
        {% csrf_token %}
        <div class="box-body">
        <div class="form-group">
            <label id="question"></label>
        </div>
            <div id="answers"> </div> 
        </div>
        <!-- /.box-body -->
        <div class="box-footer">
            <button class="btn btn-primary">Submit</button>
        </div>
    </form>
    </div>
    <!-- /.box -->
{% endblock content %}

{% block javascript  %}
    {{ block.super }}
    <script>
        $(document).ready(main());

        function main(){
            var url = "/quiz/json";

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken",  getCookie("csrftoken"));
                    }
                }
            });

            $.getJSON(
                url,
            )
            .done(function(data){
                setQuestion(data);
            })
        }

        function submitAnswer(){
            var selectedAnswerID = $("input[name='answer']:checked").val();
            alert(selectedAnswerID);
            alert(getCookie("csrftoken"));
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken",  getCookie("csrftoken"));
                    }
                }
            });

            $.ajax({
                type: "POST",
                url: "/quiz/answer/",
                //JSON.stringify
                data: {quiz_id: 1, answer_id: 2},
                success: function(){alert("Success!")},
                dataType: "json"
            });

            //Don't let the form return
            return false;
        }

        // start getCookie
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        } // end getCookie

        function setQuestion(data){
            var questionDiv = $("#question");
            var answerDiv = $("#answers");
            var answerList = []; 
            var beg = '<div class="checkbox"><label><input type="radio" name="answer" value=';
            var mid = '>'
            var end = '<\/label><\/div>'

            questionDiv.empty();
            questionDiv.append('<p>' + data.question + "</p>");

            answerDiv.empty();
            for(var i=0; i < data.answers.length; i++){
                answerList.push(beg + data.answers[i].pk + mid + data.answers[i].definition + end);
            }
            answerDiv.append(answerList.join(""));
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
    </script>

{% endblock javascript  %}